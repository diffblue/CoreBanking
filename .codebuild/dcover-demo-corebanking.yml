version: 0.2  # Always use version 2
env:
  git-credential-helper: yes
  exported-variables:
    - VERSION
    - OS
    - JDK
phases:
  install:
    runtime-versions:
      java: openjdk8
    commands:
      - echo "Entered the install phase"
      - .codebuild/install_ubuntu.sh
      - export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
      - git config --global user.email "contributions@diffblue.com"
      - git config --global user.name "Diffblue Cover Bot"
      - git remote set-url origin "git@github.com:diffblue/CoreBanking.git"
      - apt-get update -y
      - apt-get install -y
          bc
      # get branch name
      - |
        SHA=$(git rev-parse HEAD)
        # CODEBUILD_WEBHOOK_HEAD_REF isn't set if you retry a build so we have to do this instead!
        if [ -z "$CODEBUILD_WEBHOOK_HEAD_REF" ]; then
          export CODEBUILD_WEBHOOK_HEAD_REF=`git symbolic-ref HEAD --short 2>/dev/null`
          if [ -z "$CODEBUILD_WEBHOOK_HEAD_REF" ]; then
            CODEBUILD_WEBHOOK_HEAD_REF=`git branch -a --contains HEAD | sed -n 2p | awk '{ printf $1 }'`
            export CODEBUILD_WEBHOOK_HEAD_REF=${CODEBUILD_WEBHOOK_HEAD_REF#remotes/origin/}
          fi
        fi
      - BRANCH=$(git rev-parse --abbrev-ref "$CODEBUILD_WEBHOOK_HEAD_REF")
      - echo "WebhookRef:$CODEBUILD_WEBHOOK_HEAD_REF"
      - echo "Branch - $BRANCH"
      - git checkout "$BRANCH"
  build:
    commands:
      - OS=ubuntu
      - JDK=openjdk8
      - wget  https://release.diffblue.com/2020.04.a/e4dd2b989dcc690a6bc1a45a5e399b966eb3a0286708d28bb572c9936b3530bb/diffblue-cover-cli-2020.04.a-linux.zip > /dev/null
      - unzip diffblue-cover-cli-2020.04.a-linux.zip
      - |
        eval $(ssh-agent)
        aws ssm get-parameter \
          --with-decryption \
          --output text \
          --query Parameter.Value \
          --name /codebuild-github-sshkeys/cover-dogfood-push-key | ssh-add -q -
      - |
      - mvn clean compile -B
      - timeout 360 ./dcover create -d src/dcover/java --skip-test-verification --batch
      - .codebuild/dogfooding-demo.sh "$BRANCH" "$SHA"
cache:
  paths:
    - '/var/cache/apt/**/*'
    - '/var/lib/apt/lists/**/*'
    - '/root/.m2/**/*'
