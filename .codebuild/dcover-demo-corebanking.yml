version: 0.2  # Always use version 2
env:
  git-credential-helper: yes
  exported-variables:
    - VERSION
    - OS
    - JDK
phases:
  install:
    runtime-versions:
      java: openjdk8
    commands:
      - echo "Entered the install phase"
      - .codebuild/install_ubuntu.sh
      - export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
      - git config --global user.email "contributions@diffblue.com"
      - git config --global user.name "Diffblue Cover Bot"
      - apt-get update -y
      - apt-get install -y
          bc
      - echo "Entered the pre_build phase"
      # get branch name
      - |
        SHA=$(git rev-parse HEAD)
        # CODEBUILD_WEBHOOK_HEAD_REF isn't set if you retry a build so we have to do this instead!
        if [ -z "$CODEBUILD_WEBHOOK_HEAD_REF" ]; then
          export CODEBUILD_WEBHOOK_HEAD_REF=`git symbolic-ref HEAD --short 2>/dev/null`
          if [ -z "$CODEBUILD_WEBHOOK_HEAD_REF" ]; then
            CODEBUILD_WEBHOOK_HEAD_REF=`git branch -a --contains HEAD | sed -n 2p | awk '{ printf $1 }'`
            export CODEBUILD_WEBHOOK_HEAD_REF=${CODEBUILD_WEBHOOK_HEAD_REF#remotes/origin/}
          fi
        fi
      - BRANCH=$(git rev-parse --abbrev-ref "$CODEBUILD_WEBHOOK_HEAD_REF")
      - echo "WebhookRef:$CODEBUILD_WEBHOOK_HEAD_REF"
      - echo "Branch - $BRANCH"
  build:
    commands:
      - if [ ! -d ".git" ]; then .codebuild/include_git_dir.sh "https://github.com/diffblue/jcover.git" ${CODEBUILD_RESOLVED_SOURCE_VERSION}; fi
      - OS=ubuntu
      - JDK=openjdk8
      - wget  https://release.diffblue.com/2020.04.a/e4dd2b989dcc690a6bc1a45a5e399b966eb3a0286708d28bb572c9936b3530bb/diffblue-cover-cli-2020.04.a-linux.zip
      - unzip diffblue-cover-cli-2020.04.a-linux.zip
      - |
        eval $(ssh-agent)
        aws ssm get-parameter \
          --with-decryption \
          --output text \
          --query Parameter.Value \
          --name /codebuild-github-sshkeys/cover-dogfood-push-key | ssh-add -q -
      - |
      - FULL_SHA=$(git rev-parse HEAD)
      - echo "$FULL_SHA"
      - GIT_BRANCH=$(git branch -a --contains "$FULL_SHA" | head -n 1)
      - echo "$GIT_BRANCH"
      - git branch
      - git checkout "$GIT_BRANCH"
      - git branch
      - mvn clean compile
      - ls
      - timeout 360 ./dcover create -d src/dcover/java --skip-test-verification --batch
      - git add src/dcover
      - git commit -m "Add diffblue tests"
        #- .codebuild/runTests.sh
        #post_build:
        #commands:
            #- PR_TEXT=$(python3 .codebuild/getTestOutput.py "$(cat mavenOutput.txt)")
            #- echo "$PR_TEXT"
        #- .codebuild/github-post-pr.sh "$FULL_SHA" "$PR_TEXT"
cache:
  paths:
    - '/var/cache/apt/**/*'
    - '/var/lib/apt/lists/**/*'
    - '/root/.m2/**/*'
